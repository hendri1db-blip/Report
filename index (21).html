<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Report Builder v3.1 — with Claims List</title>
<style>
  :root{ --fg:#111;--muted:#555;--bg:#fff;--line:#ddd;--cta:#0a66c2;--danger:#a00; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bg)}
  header{position:sticky;top:0;background:#0b4574;color:#fff;border-bottom:1px solid var(--line);z-index:2}
  .wrap{max-width:1000px;margin:0 auto;padding:12px}
  h1{font-size:20px;margin:2px 0}
  .sub{color:#d7e8ff;font-size:12px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button,.btn{appearance:none;border:1px solid var(--line);background:#f7f7f7;border-radius:10px;padding:8px 10px;font:inherit;cursor:pointer}
  button.primary{background:var(--cta);border-color:var(--cta);color:#fff}
  button.danger{color:#fff;background:var(--danger);border-color:var(--danger)}
  section{border-top:1px solid var(--line);padding:12px}
  section:first-of-type{border-top:none}
  h2{font-size:16px;margin:0 0 8px}
  label{display:block;font-size:13px;margin:6px 0 2px;color:#333}
  input,textarea{width:100%;border:1px solid var(--line);border-radius:8px;padding:8px;font:inherit}
  textarea{min-height:80px}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  .photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px}
  .card{border:1px solid var(--line);border-radius:12px;padding:8px}
  .thumb{width:100%;height:160px;object-fit:cover;border-radius:8px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}
  footer{padding:16px 12px 40px;color:var(--muted);text-align:center}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border:1px solid var(--line);padding:6px 8px;text-align:left;font-size:12px}
  .table th{background:#f2f6ff}
  .claims{border:1px solid var(--line);border-radius:12px;padding:8px;margin-top:12px}
  .claims h3{margin:0 0 8px;font-size:14px}
  .claims-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .claims-actions input{width:260px}
  .right{margin-left:auto}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Report Builder</h1>
    <div class="sub">v3.1 — single-file app. Photos, transcript & fees included. Export to PDF. With claims list.</div>
    <div class="bar">
      <button id="btnNew" class="primary">New Report</button>
      <button id="btnPrint">Export / Print PDF</button>
      <button id="btnSaveFile">Save Draft (download)</button>
      <label class="btn"><input type="file" id="loadDraft" accept="application/json" hidden/>Load Draft (from file)</label>
      <button id="btnReset" class="danger">Reset This Report</button>
      <span class="pill" id="autosaveNote">Autosaved</span>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- CLAIMS LIST (browser-saved) -->
  <section id="claimsSection">
    <h2>Claims List (saved in this browser)</h2>
    <div class="claims">
      <div class="claims-actions">
        <label style="margin:0">
          <span class="muted">Title for this claim</span>
          <input id="claimTitleInput" placeholder="e.g., HL-2025-0912 – Roof leak – 15 Rose St" />
        </label>
        <button id="btnSaveBrowser" class="primary">Save to Browser</button>
        <button id="btnSaveBrowserAs">Save As Copy</button>
        <span class="pill right">Data stays on this device</span>
      </div>
      <table class="table" id="claimsTable">
        <thead>
          <tr><th>Title</th><th>Insured</th><th>Updated</th><th>Actions</th></tr>
        </thead>
        <tbody id="claimsTbody"></tbody>
      </table>
      <p id="noClaims" class="muted" style="display:none">No saved claims yet. Use <b>Save to Browser</b> to add one.</p>
    </div>
  </section>

  <section>
    <h2>Header & Postal Block</h2>
    <div class="grid">
      <div>
        <label>Confidentiality Line (top of PDF)</label>
        <input id="hdr.confidential" placeholder="Private and Confidential"/>
      </div>
      <div>
        <label>Year (right of Insurer)</label>
        <input id="hdr.year" placeholder="2025"/>
      </div>
      <div>
        <label>Insurer Name</label>
        <input id="meta.insurer" placeholder="Insurer name"/>
      </div>
      <div>
        <label>Attention</label>
        <input id="meta.attention" placeholder="Claims Department"/>
      </div>
      <div>
        <label>Postal Block (multiline)</label>
        <textarea id="hdr.postal" placeholder="Line 1&#10;Line 2&#10;City&#10;Postcode"></textarea>
      </div>
      <div>
        <label>Report Date</label>
        <input id="meta.date" type="date" />
      </div>
    </div>
  </section>

  <section>
    <h2>The Claim</h2>
    <div class="grid">
      <div><label>Claim Number</label><input id="meta.claimNo" /></div>
      <div><label>Policy Number</label><input id="meta.policyNumber" /></div>
      <div><label>Insured</label><input id="meta.insured" /></div>
      <div><label>Policy Cover</label><input id="meta.cover" /></div>
      <div><label>Policy Inception</label><input id="meta.inception" placeholder="Insurer to refer to their records"/></div>
      <div><label>Sum Insured (text)</label><input id="meta.sumInsuredMeta" placeholder="e.g., R 1 234 567.00 incl."/></div>
      <div><label>Policy Deductible</label><input id="meta.policyDeductible"/></div>
      <div><label>Risk Address</label><input id="meta.riskAddress"/></div>
      <div><label>Date of Loss</label><input id="meta.dateOfLoss" type="date"/></div>
      <div><label>Cause of Loss</label><input id="meta.causeOfLoss" placeholder="e.g., Theft/Malicious Damage"/></div>
      <div><label>Date Reported</label><input id="meta.dateReported" type="date"/></div>
      <div><label>Date Assessed</label><input id="meta.dateAssessed" type="date"/></div>
      <div><label>Estimated Loss (text)</label><input id="meta.estimatedLoss" placeholder="R 0.00"/></div>
      <div><label>Suggested Settlement (text)</label><input id="meta.suggestedSettlement" placeholder="e.g., Cash in Lieu: R ..."/></div>
    </div>
  </section>

  <section>
    <h2>Report Content</h2>
    <div>
      <label>Introduction</label><textarea id="sec.intro" placeholder="Intro..."></textarea>
      <label>The Risk (property description)</label><textarea id="sec.risk" placeholder="Main dwelling, outbuildings, boundary walls..."></textarea>
      <label>Sum Insured / Value at Risk</label><textarea id="sec.sumInsured" placeholder="Notes on V@R..."></textarea>
      <label>Other Insurance / Previous Losses</label><textarea id="sec.otherInsurance" placeholder="Any other policies; prior claims..."></textarea>
      <label>Circumstances of the Loss</label><textarea id="sec.circumstances" placeholder="When, where, how..."></textarea>
      <label>Assessment</label><textarea id="sec.assessment" placeholder="Observations; compliance; workmanship..."></textarea>
      <label>Invoices / Quotations</label><textarea id="sec.invoices" placeholder="List invoices & quotes with dates..."></textarea>
      <label>Quantum and Adjustment</label><textarea id="sec.quantum" placeholder="Calculations; excess; limits; cash-in-lieu vs repair..."></textarea>
      <label>Policy Cover / Terms / Conditions / Liability</label><textarea id="sec.policyResponse" placeholder="Cite wording and relevant exclusions..."></textarea>
      <label>Settlement Recommendations</label><textarea id="sec.recommendation" placeholder="Repudiate / Authorise / Cash-in-lieu..."></textarea>
      <label>Conclusion</label><textarea id="sec.conclusion" placeholder="Submission for insurer’s perusal..."></textarea>
      <label>Internal Notes (won’t print unless copied)</label><textarea id="sec.notes" placeholder="Scratchpad…"></textarea>
    </div>
  </section>

  <section>
    <div class="row">
      <h2 style="margin-right:auto">Photos</h2>
      <label class="btn"><input type="file" id="addCam" accept="image/*" capture="environment" multiple hidden/>Use Camera</label>
      <label class="btn"><input type="file" id="addFiles" accept="image/*" multiple hidden/>Upload Images</label>
    </div>
    <div id="photoList" class="photos"></div>
  </section>

  <section>
    <h2>Transcript / Voice Note</h2>
    <div class="grid">
      <div><label>Title</label><input id="tr.title" value="Site Visit Transcript"/></div>
      <div><label>Captured At</label><input id="tr.capturedAt" type="datetime-local"/></div>
    </div>
    <div class="row" style="margin:8px 0">
      <label class="btn"><input type="file" id="importTxt" accept="text/plain" hidden/>Import .txt Transcript</label>
      <label class="btn"><input type="file" id="audioFile" accept="audio/*" capture hidden/>Record/Upload Audio</label>
      <audio id="audioCtl" controls style="max-width:100%"></audio>
    </div>
    <label>Transcript Body</label>
    <textarea id="tr.body" placeholder="E.g., 09:15 Arrived on site. Met with insured..."></textarea>
    <div class="muted">Note: Audio cannot be embedded into the PDF. Share the audio file separately when sending your report.</div>
  </section>

  <section>
    <h2>Note of Fee (prints as a separate page)</h2>
    <table class="table">
      <thead><tr><th>Description</th><th>Amount (R)</th></tr></thead>
      <tbody id="feeRows">
        <tr><td contenteditable="true">Assessment Fee</td><td contenteditable="true">0.00</td></tr>
        <tr><td contenteditable="true">Site Visit / Travel</td><td contenteditable="true">0.00</td></tr>
        <tr><td contenteditable="true">Disbursements</td><td contenteditable="true">0.00</td></tr>
      </tbody>
      <tfoot>
        <tr><th>Sub-Total</th><td id="feeSub">0.00</td></tr>
        <tr><th>VAT (15%)</th><td id="feeVat">0.00</td></tr>
        <tr><th>Total</th><td id="feeTotal">0.00</td></tr>
      </tfoot>
    </table>
    <div class="muted" style="margin-top:6px">Tip: Tap in cells to edit. Totals auto-calc in PDF export.</div>
  </section>

</main>

<footer>Tip: Use “Export / Print PDF” to generate a PDF. Data is kept in your browser.</footer>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // ---- Original single-file state ----
  const state = {
    hdr:{ confidential:"Private and Confidential", year:new Date().getFullYear().toString(), postal:"" },
    meta:{ insurer:"", date:new Date().toISOString().slice(0,10), claimNo:"", policyNumber:"", insured:"", cover:"", inception:"Insurer to refer to their records", riskAddress:"", sumInsuredMeta:"", policyDeductible:"", attention:"Claims Department", dateOfLoss:"", causeOfLoss:"", dateReported:"", dateAssessed:"", estimatedLoss:"", suggestedSettlement:"" },
    sec:{intro:"",risk:"",sumInsured:"",otherInsurance:"",circumstances:"",assessment:"",invoices:"",quantum:"",policyResponse:"",recommendation:"",conclusion:"",notes:""},
    photos:[],
    tr:{title:"Site Visit Transcript",capturedAt:new Date().toISOString(),body:""},
    audio:{dataUrl:null,filename:null},
    fees:[["Assessment Fee","0.00"],["Site Visit / Travel","0.00"],["Disbursements","0.00"]]
  };
  const LSKEY_SINGLE = "rb_singlefile_v31_clean";

  // ---- New: multi-claim storage ----
  const LSKEY_INDEX = "rb_claims_index_v31";
  function loadIndex(){
    try{ return JSON.parse(localStorage.getItem(LSKEY_INDEX))||[] }catch{ return [] }
  }
  function saveIndex(idx){
    localStorage.setItem(LSKEY_INDEX, JSON.stringify(idx));
  }
  function claimKey(id){ return "rb_claim_v31:"+id; }
  function loadClaim(id){
    try{ return JSON.parse(localStorage.getItem(claimKey(id)))||null }catch{ return null }
  }
  function saveClaim(id, data){
    localStorage.setItem(claimKey(id), JSON.stringify(data));
  }
  function deleteClaim(id){
    localStorage.removeItem(claimKey(id));
    const idx = loadIndex().filter(x=>x.id!==id);
    saveIndex(idx);
  }

  // ---- Helpers ----
  function newId(){ return 'c'+Math.random().toString(36).slice(2,10)+Date.now().toString(36); }
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  function toLocalDT(val){ const d=new Date(val||new Date()); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16); }
  function num(s){ return parseFloat((s||"0").toString().replace(/[^0-9.\-]/g,""))||0; }

  // ---- Bind UI to state ----
  function bindHeader(){
    $("hdr.confidential").value = state.hdr.confidential;
    $("hdr.confidential").addEventListener("input", ()=>{ state.hdr.confidential=$("hdr.confidential").value; saveSingle(); });
    $("hdr.year").value = state.hdr.year;
    $("hdr.year").addEventListener("input", ()=>{ state.hdr.year=$("hdr.year").value; saveSingle(); });
    $("hdr.postal").value = state.hdr.postal;
    $("hdr.postal").addEventListener("input", ()=>{ state.hdr.postal=$("hdr.postal").value; saveSingle(); });
  }
  function bindMeta(){
    const map = ["insurer","date","claimNo","policyNumber","insured","cover","inception","riskAddress","sumInsuredMeta","policyDeductible","attention","dateOfLoss","causeOfLoss","dateReported","dateAssessed","estimatedLoss","suggestedSettlement"];
    for(const k of map){
      const el = $("meta."+k); if(!el) continue; el.value = state.meta[k]||"";
      el.addEventListener("input", ()=>{ state.meta[k]=el.value; saveSingle(); });
    }
  }
  function bindSections(){
    for(const k of Object.keys(state.sec)){
      const el = $("sec."+k); if(!el) continue; el.value = state.sec[k]||"";
      el.addEventListener("input", ()=>{ state.sec[k]=el.value; saveSingle(); });
    }
  }
  function bindTranscript(){
    $("tr.title").value = state.tr.title||"";
    $("tr.title").addEventListener("input", ()=>{ state.tr.title = $("tr.title").value; saveSingle(); });
    $("tr.capturedAt").value = toLocalDT(state.tr.capturedAt);
    $("tr.capturedAt").addEventListener("input", ()=>{ const v=$("tr.capturedAt").value; state.tr.capturedAt = new Date(v).toISOString(); saveSingle(); });
    $("tr.body").value = state.tr.body||"";
    $("tr.body").addEventListener("input", ()=>{ state.tr.body = $("tr.body").value; saveSingle(); });
    $("audioFile").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const dataUrl = await fileToDataURL(f); state.audio = {dataUrl, filename:f.name||"voice_note.m4a"};
      $("audioCtl").src = dataUrl; saveSingle();
    });
    $("importTxt").addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const txt = await f.text(); state.tr.body = txt; $("tr.body").value = txt; saveSingle();
    });
  }
  function bindFees(){
    const tbody = $("feeRows"); tbody.innerHTML = "";
    state.fees.forEach(([desc, amt], i)=>{
      const tr = document.createElement("tr");
      const td1 = document.createElement("td"); td1.contentEditable = "true"; td1.textContent = desc;
      const td2 = document.createElement("td"); td2.contentEditable = "true"; td2.textContent = amt;
      td1.addEventListener("input", ()=>{ state.fees[i][0] = td1.textContent.trim(); saveSingle(); });
      td2.addEventListener("input", ()=>{ state.fees[i][1] = td2.textContent.trim(); saveSingle(); });
      tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
    });
  }
  function renderPhotos(){
    const list = $("photoList"); list.innerHTML="";
    state.photos.forEach((p, idx)=>{
      const card = document.createElement("div"); card.className="card";
      card.innerHTML = `
        <img class="thumb" src="${p.dataUrl}" alt="photo">
        <label>Caption<input data-k="caption" value="${p.caption||""}"></label>
        <label>Taken<input data-k="takenAt" type="datetime-local" value="${toLocalDT(p.takenAt||new Date())}"></label>
        <div class="row" style="justify-content:space-between">
          <span class="muted">#${idx+1}</span>
          <button data-act="rm" class="danger" style="padding:4px 8px">Remove</button>
        </div>`;
      card.querySelector('[data-k="caption"]').addEventListener('input', (e)=>{ p.caption=e.target.value; saveSingle(); });
      card.querySelector('[data-k="takenAt"]').addEventListener('input', (e)=>{ p.takenAt=new Date(e.target.value).toISOString(); saveSingle(); });
      card.querySelector('[data-act="rm"]').addEventListener('click', ()=>{ state.photos = state.photos.filter(x=>x!==p); renderPhotos(); saveSingle(); });
      list.appendChild(card);
    });
  }
  async function addPhotos(fileList){
    const files = Array.from(fileList||[]);
    for(const f of files){ const dataUrl = await fileToDataURL(f);
      state.photos.push({id:crypto.randomUUID(), dataUrl, caption:"", takenAt:new Date().toISOString()});
    }
    renderPhotos(); saveSingle();
  }

  // ---- Single-file autosave (kept for continuity with original) ----
  function saveSingle(){
    try{ localStorage.setItem(LSKEY_SINGLE, JSON.stringify(state)); $("autosaveNote").textContent = "Autosaved " + new Date().toLocaleTimeString(); }catch{}
  }
  function loadSingle(){
    try{
      const raw = localStorage.getItem(LSKEY_SINGLE); if(!raw) return;
      const obj = JSON.parse(raw);
      Object.assign(state.hdr, obj.hdr||{});
      Object.assign(state.meta, obj.meta||{});
      Object.assign(state.sec, obj.sec||{});
      state.photos = obj.photos||[];
      Object.assign(state.tr, obj.tr||{});
      state.audio = obj.audio||{dataUrl:null,filename:null};
      state.fees = obj.fees||state.fees;
    }catch{}
  }

  // ---- Claims list (index) rendering ----
  function renderClaims(){
    const idx = loadIndex().sort((a,b)=>b.updated-a.updated);
    const body = $("claimsTbody");
    body.innerHTML = "";
    $("noClaims").style.display = idx.length? "none":"block";
    for(const item of idx){
      const tr = document.createElement("tr");
      const d = new Date(item.updated||Date.now());
      tr.innerHTML = `<td>${escapeHtml(item.title||"(Untitled)")}</td>
                      <td>${escapeHtml(item.insured||"")}</td>
                      <td>${d.toLocaleString()}</td>
                      <td>
                        <button data-open="${item.id}">Open</button>
                        <button data-del="${item.id}" class="danger">Delete</button>
                      </td>`;
      body.appendChild(tr);
    }
  }
  function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

  // ---- Save to browser (index + blob) ----
  function collect(){
    return JSON.parse(JSON.stringify(state));
  }
  function populate(data){
    Object.assign(state.hdr, data.hdr||{});
    Object.assign(state.meta, data.meta||{});
    Object.assign(state.sec, data.sec||{});
    state.photos = data.photos||[];
    Object.assign(state.tr, data.tr||{});
    state.audio = data.audio||{dataUrl:null,filename:null};
    state.fees = data.fees||[["Assessment Fee","0.00"],["Site Visit / Travel","0.00"],["Disbursements","0.00"]];
    bindHeader(); bindMeta(); bindSections(); bindTranscript(); bindFees(); renderPhotos();
    if(state.audio?.dataUrl) $("audioCtl").src = state.audio.dataUrl;
    saveSingle();
  }

  function saveToBrowser(asCopy=false){
    const idx = loadIndex();
    let title = $("claimTitleInput").value.trim() || (state.meta.claimNo? state.meta.claimNo+" – "+(state.meta.insured||"") : "Untitled");
    const data = collect();
    data.updated = Date.now();
    let id;
    if(!asCopy){
      // try find existing by id in memory on this page
      id = window.__currentId || null;
    }
    if(!id){
      // try match by exact title+insured
      const existing = idx.find(x=>x.title===title && x.insured===state.meta.insured);
      if(existing){ id = existing.id; }
    }
    if(!id){ id = newId(); }
    window.__currentId = id;

    saveClaim(id, data);
    const row = {id, title, insured:state.meta.insured||"", updated:data.updated};
    const pos = idx.findIndex(x=>x.id===id);
    if(pos>=0){ idx[pos] = row; } else { idx.push(row); }
    saveIndex(idx);
    renderClaims();
    $("autosaveNote").textContent = "Saved to browser " + new Date().toLocaleTimeString();
  }

  // ---- Events ----
  $("btnNew").addEventListener("click", ()=>{
    window.__currentId = null;
    populate({
      hdr:{ confidential:"Private and Confidential", year:new Date().getFullYear().toString(), postal:"" },
      meta:{ insurer:"", date:new Date().toISOString().slice(0,10), claimNo:"", policyNumber:"", insured:"", cover:"", inception:"Insurer to refer to their records", riskAddress:"", sumInsuredMeta:"", policyDeductible:"", attention:"Claims Department", dateOfLoss:"", causeOfLoss:"", dateReported:"", dateAssessed:"", estimatedLoss:"", suggestedSettlement:"" },
      sec:{intro:"",risk:"",sumInsured:"",otherInsurance:"",circumstances:"",assessment:"",invoices:"",quantum:"",policyResponse:"",recommendation:"",conclusion:"",notes:""},
      photos:[],
      tr:{title:"Site Visit Transcript",capturedAt:new Date().toISOString(),body:""},
      audio:{dataUrl:null,filename:null},
      fees:[["Assessment Fee","0.00"],["Site Visit / Travel","0.00"],["Disbursements","0.00"]]
    });
    $("claimTitleInput").value = "";
    window.scrollTo({top:0,behavior:"smooth"});
  });

  $("btnSaveBrowser").addEventListener("click", ()=> saveToBrowser(false));
  $("btnSaveBrowserAs").addEventListener("click", ()=> saveToBrowser(true));

  document.addEventListener("click", (e)=>{
    const openId = e.target.getAttribute && e.target.getAttribute("data-open");
    const delId  = e.target.getAttribute && e.target.getAttribute("data-del");
    if(openId){
      const data = loadClaim(openId);
      if(data){ populate(data); window.__currentId = openId; }
    }
    if(delId){
      if(confirm("Delete this saved claim?")){ deleteClaim(delId); renderClaims(); }
    }
  });

  $("btnSaveFile").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(collect(),null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`report_draft_${state.meta.claimNo||Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
  });
  $("loadDraft").addEventListener("change", async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{ const obj=JSON.parse(await f.text()); populate(obj); alert("Draft loaded."); }
    catch{ alert("Invalid JSON file."); }
  });

  $("btnReset").addEventListener("click", ()=>{ if(!confirm('Clear all fields for this current report?')) return; localStorage.removeItem(LSKEY_SINGLE); window.__currentId=null; location.reload(); });

  $("addCam").addEventListener("change", e=> addPhotos(e.target.files));
  $("addFiles").addEventListener("change", e=> addPhotos(e.target.files));

  $("btnPrint").addEventListener("click", ()=>{
    // Recompute fees
    const feeSub = Array.from(document.querySelectorAll("#feeRows tr")).reduce((acc,tr)=>{
      const tds = tr.querySelectorAll("td");
      return acc + num(tds[1]?.textContent||"0");
    },0);
    const feeVat = +(feeSub*0.15).toFixed(2);
    const feeTotal = +(feeSub+feeVat).toFixed(2);

    const safe = (s)=> (s||"").replaceAll("\n","<br/>");
    const style = `
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:24px}
        h1{font-size:22px;margin:0}
        h2{font-size:18px;margin:20px 0 8px}
        h3{font-size:16px;margin:16px 0 6px}
        p,li,td,th{font-size:12px;line-height:1.5}
        .muted{color:#555}
        .hr{border:none;border-top:1px solid #ddd;margin:16px 0}
        .table{width:100%;border-collapse:collapse;margin-top:4px}
        .table th,.table td{border:1px solid #ddd;padding:6px 8px;text-align:left}
        .table th{background:#f2f6ff}
        .right{text-align:right}
        .block{border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:8px}
        @media print{.pagebreak{page-break-before:always}}
      </style>`;

    const postalHtml = safe(state.hdr.postal);
    const photos = state.photos.map((p,i)=>`
      <tr>
        <td style="width:140px" class="muted">Photo ${i+1}${p.caption?` – ${p.caption}`:""}</td>
        <td><img src="${p.dataUrl}" style="max-width:100%;height:auto;border:1px solid #ddd;border-radius:6px"/></td>
      </tr>
    `).join("");

    const feeRows = Array.from(document.querySelectorAll("#feeRows tr")).map(tr=>{
      const tds = tr.querySelectorAll("td");
      const d = (tds[0]?.textContent||"").trim();
      const a = (tds[1]?.textContent||"").trim();
      return `<tr><td>${d}</td><td class="right">${a}</td></tr>`;
    }).join("");

    const html = `<!doctype html><html><head><meta charset="utf-8"/>${style}</head><body>
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="muted" style="font-weight:600">${state.hdr.confidential||""}</div>
          <h1 style="margin-top:4px">Report</h1>
          <div style="white-space:pre-line">${postalHtml}</div>
        </div>
        <div class="muted right">
          <div><strong>${state.meta.insurer||""}</strong> ${state.hdr.year||""}</div>
          <div>Date: ${state.meta.date||""}</div>
          <div>Attention: ${state.meta.attention||""}</div>
        </div>
      </div>

      <h2>THE CLAIM</h2>
      <table class="table">
        <tr><th>Claim Number</th><td>${state.meta.claimNo||""}</td></tr>
        <tr><th>Insured</th><td>${state.meta.insured||""}</td></tr>
        <tr><th>Policy Number</th><td>${state.meta.policyNumber||""}</td></tr>
        <tr><th>Policy Cover</th><td>${state.meta.cover||""}</td></tr>
        <tr><th>Policy Inception</th><td>${state.meta.inception||"Insurer to refer to their records"}</td></tr>
        <tr><th>Sum Insured</th><td>${state.meta.sumInsuredMeta||""}</td></tr>
        <tr><th>Policy Deductible</th><td>${state.meta.policyDeductible||""}</td></tr>
        <tr><th>Risk Address</th><td>${state.meta.riskAddress||""}</td></tr>
        <tr><th>Date of Loss</th><td>${state.meta.dateOfLoss||""}</td></tr>
        <tr><th>Cause of Loss</th><td>${state.meta.causeOfLoss||""}</td></tr>
        <tr><th>Date Reported</th><td>${state.meta.dateReported||""}</td></tr>
        <tr><th>Date Assessed</th><td>${state.meta.dateAssessed||""}</td></tr>
        <tr><th>Estimated Loss</th><td>${state.meta.estimatedLoss||""}</td></tr>
        <tr><th>Suggested Settlement</th><td>${state.meta.suggestedSettlement||""}</td></tr>
      </table>

      <h2>INTRODUCTION</h2>
      <div class="block">${(state.sec.intro||"").replaceAll("\\n","<br/>")}</div>

      <h2>THE RISK</h2>
      <div class="block">${(state.sec.risk||"").replaceAll("\\n","<br/>")}</div>

      <h2>SUM INSURED / VALUE AT RISK</h2>
      <div class="block">${(state.sec.sumInsured||"").replaceAll("\\n","<br/>")}</div>

      <h2>OTHER INSURANCE / PREVIOUS LOSSES</h2>
      <div class="block">${(state.sec.otherInsurance||"").replaceAll("\\n","<br/>")}</div>

      <h2>CIRCUMSTANCES OF THE LOSS</h2>
      <div class="block">${(state.sec.circumstances||"").replaceAll("\\n","<br/>")}</div>

      <h2>ASSESSMENT</h2>
      <div class="block">${(state.sec.assessment||"").replaceAll("\\n","<br/>")}</div>

      <h2>INVOICES / QUOTATIONS</h2>
      <div class="block">${(state.sec.invoices||"").replaceAll("\\n","<br/>")}</div>

      <h2>QUANTUM AND ADJUSTMENT</h2>
      <div class="block">${(state.sec.quantum||"").replaceAll("\\n","<br/>")}</div>

      <h2>POLICY COVER / TERMS / CONDITIONS / LIABILITY</h2>
      <div class="block">${(state.sec.policyResponse||"").replaceAll("\\n","<br/>")}</div>

      <h2>SETTLEMENT RECOMMENDATIONS</h2>
      <div class="block">${(state.sec.recommendation||"").replaceAll("\\n","<br/>")}</div>

      <div class="pagebreak"></div>
      <h2>PHOTO RECORD</h2>
      <table class="table">${photos||""}</table>

      <div class="pagebreak"></div>
      <h2>${state.tr.title||'Transcript'}</h2>
      <div class="muted">Captured at: ${new Date(state.tr.capturedAt||new Date()).toLocaleString()}</div>
      <div class="block">${(state.tr.body||"").replaceAll("\\n","<br/>")}</div>

      <div class="pagebreak"></div>
      <h2>NOTE OF FEE</h2>
      <table class="table">
        <thead><tr><th>Description</th><th class="right">Amount (R)</th></tr></thead>
        <tbody>${feeRows}</tbody>
        <tfoot>
          <tr><th>Sub-Total</th><td class="right">${feeSub.toFixed(2)}</td></tr>
          <tr><th>VAT (15%)</th><td class="right">${feeVat.toFixed(2)}</td></tr>
          <tr><th>Total</th><td class="right"><strong>${feeTotal.toFixed(2)}</strong></td></tr>
        </tfoot>
      </table>
    </body></html>`;

    const w = window.open("","_blank"); if(!w){ alert('Popup blocked. Allow popups and try again.'); return; }
    w.document.write(html); w.document.close(); w.focus(); setTimeout(()=>w.print(), 300);
  });

  // ---- Init ----
  function init(){
    loadSingle();
    bindHeader(); bindMeta(); bindSections(); bindTranscript(); bindFees(); renderPhotos();
    if(state.audio?.dataUrl) $("audioCtl").src = state.audio.dataUrl;
    if(!$("meta.date").value) $("meta.date").value = state.meta.date;
    renderClaims();
  }
  init();
})();</script>
</body>
</html>